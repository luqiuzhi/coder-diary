# Redis的持久化策略

## 1. RDB（Redis Database）

RDB持久化通过创建**数据快照**来实现。它会在指定的时间间隔内，将内存中所有数据的某一时刻状态保存到一个二进制文件中（默认名为 `dump.rdb`）。

**工作原理：**
- **定时触发**：在 `redis.conf` 配置文件中，你可以设置如 `save 900 1`（900秒内至少有1个键被改变）这样的规则，当条件满足时，Redis会fork一个子进程来创建RDB文件。
- **手动触发**：通过执行 `SAVE`（同步，会阻塞服务器）或 `BGSAVE`（后台异步）命令来创建快照。

### 优点：
- **高性能**：RDB是数据的紧凑压缩文件，恢复大数据集时的速度比AOF快很多。
- **适合备份与灾难恢复**：单一的RDB文件非常适合用于备份、传输到数据中心或用于容灾。
- **最大化Redis性能**：父进程唯一需要做的就是fork一个子进程，由子进程完成所有持久化工作，避免了复杂的IO操作。
- **更紧凑的文件**：RDB文件是二进制格式，在相同数据集下，通常比AOF文件小。

### 缺点：
- **数据安全性较低**：因为它是定时快照，所以在两次快照之间如果发生宕机，会丢失最后一次快照之后的所有数据。
- **Fork可能阻塞**：当数据集非常大时，fork子进程的过程可能会非常耗时，导致Redis在毫秒级甚至秒级内无法响应客户端请求。

### 适用场景：
- **对数据完整性要求不高的场景**：例如用于缓存，丢失部分数据可以接受。
- **需要快速重启和恢复**：大规模的灾难恢复，使用RDB文件可以更快地恢复数据。
- **用于备份**：定期生成RDB快照，用于存档、版本化（因为每个RDB文件都是某一时刻的完整快照）。

---

## 2. AOF（Append Only File）

AOF持久化通过**记录所有写操作命令**来实现。它将这些命令以Redis协议的格式追加到一个日志文件的末尾。当Redis重启时，会重新执行AOF文件中的所有命令来重建数据。

**工作原理：**
- **记录日志**：每一个会改变数据集的命令都会被追加到AOF缓冲区，然后根据配置的同步策略写入到磁盘的AOF文件中。
- **重写机制**：随着时间推移，AOF文件会越来越大。Redis提供了 `BGREWRITEAOF` 命令，会fork一个子进程来创建一个新的、更小的AOF文件，这个文件包含了恢复当前数据集所需的最少命令集合。

**同步策略（`appendfsync` 配置项）：**
- **no**：由操作系统决定何时同步，性能最好，但数据安全性最差。
- **everysec**：每秒同步一次。是默认和推荐的策略，在性能和安全性之间取得了很好的平衡，最多丢失1秒的数据。
- **always**：每个写命令都同步。数据最安全，但性能损耗严重，因为涉及到大量的磁盘IO。

### 优点：
- **数据安全性极高**：尤其是在 `appendfsync always` 策略下，最多只丢失一个命令的数据。`everysec` 策略也最多只丢失1秒的数据。
- **可读性**：AOF文件是纯文本格式，记录了所有操作命令，便于理解和分析。

### 缺点：
- **文件体积通常更大**：AOF文件记录的是操作日志，通常比同数据集的RDB文件大。
- **恢复速度较慢**：在数据集很大时，AOF的恢复过程（重放所有命令）比RDB要慢。
- **性能略低于RDB**：特别是在高写入负载下，即使使用 `everysec` 策略，AOF的性能通常也略低于RDB。

### 适用场景：
- **对数据安全性和完整性要求非常高的场景**：例如作为主数据库使用，不能容忍数分钟的数据丢失。
- **需要做灾难恢复，但可以接受较慢的恢复速度**。
- **需要分析数据操作历史**的场景（通过AOF文件可以回放所有操作）。

---

## 3. 混合持久化（RDB + AOF）

这是Redis 4.0之后引入的持久化方式，结合了RDB和AOF的优点。在开启混合持久化后，AOF重写时不再是单纯地将命令写入AOF文件，而是会**先将当前内存的数据以RDB格式写入AOF文件的开头，然后再将重写缓冲期内的增量命令以AOF格式追加到文件末尾**。

这样生成的AOF文件，前半部分是RDB格式的全量数据，后半部分是AOF格式的增量数据。

### 优点：
- **结合了RDB和AOF的优点**：快速加载（利用RDB部分） + 数据丢失少（利用AOF部分）。
- **推荐的生产环境配置**：这通常是最佳实践，既能享受到RDB快速恢复的好处，又能获得AOF级别的数据安全性。

### 缺点：
- AOF文件的**可读性变差**，因为开头部分是二进制RDB数据。
- 兼容性要求Redis 4.0以上版本。

### 适用场景：
- **几乎所有生产环境**。这是目前最推荐的方式，在数据安全性和启动速度之间取得了最佳平衡。

---

## 总结与选择建议

| 特性 | RDB | AOF | 混合持久化 |
| :--- | :--- | :--- | :--- |
| **数据安全性** | 低（定时，可能丢失分钟级数据） | 高（秒级或命令级） | 高（同AOF） |
| **文件大小** | 小（二进制压缩） | 大（文本命令） | 中等（比纯AOF小） |
| **恢复速度** | **快** | 慢 | **非常快**（利用了RDB部分） |
| **对性能影响** | Fork时可能阻塞 | 写入压力相对较大 | 与AOF类似 |
| **数据可读性** | 否（二进制） | 是（文本） | 部分（开头是二进制） |

**如何选择：**

1.  **如果只是用Redis做缓存，且不介意服务器重启时丢失数据**：
    *   可以**关闭所有持久化**以获得最佳性能。

2.  **如果非常关心数据，但又可以容忍数分钟的数据丢失**：
    *   使用 **RDB**。
    *   可以设置 `save 900 1` 和 `save 300 10` 等规则来平衡性能和数据安全。

3.  **如果需要最高级别的数据安全性和完整性，将Redis作为主数据库**：
    *   在Redis 4.0以前，使用 **AOF**，并将 `appendfsync` 设置为 `everysec`。
    *   在Redis 4.0+，**强烈推荐使用混合持久化**。这是两全其美的方法。

**最佳实践配置（Redis 4.0+）：**
```bash
# 在redis.conf中开启AOF
appendonly yes
# 开启混合持久化
aof-use-rdb-preamble yes
# 保持AOF的默认同步策略
appendfsync everysec
```
这样，既拥有了AOF的数据安全性，又在重写和恢复时享受了RDB的速度优势。同时，建议仍然保留RDB的定时备份规则，因为单一的RDB文件在某些场景下（如历史备份）依然非常有用。