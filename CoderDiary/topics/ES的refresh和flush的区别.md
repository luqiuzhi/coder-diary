# ESçš„refreshå’Œflushçš„åŒºåˆ«

å¦‚æœå¯¹ESçš„ç´¢å¼•è¿‡ç¨‹æœ‰æ‰€äº†è§£ï¼Œå°±èƒ½å¾ˆå¥½çš„ç†è§£refreshå’Œflushçš„åŒºåˆ«ã€‚

è¿™ä¸¤ç§æ“ä½œéƒ½æ˜¯åœ¨ESçš„ç´¢å¼•è¿‡ç¨‹ä¸­å‘ç”Ÿçš„ï¼Œä½†æ˜¯ç›®çš„ä¸åŒï¼Œå¹¶ä¸”æ‰§è¡Œæ—¶é—´ä¹Ÿä¸åŒã€‚

## æ ¸å¿ƒåŒºåˆ«æ€»ç»“

| ç‰¹æ€§         | **Refresh**      | **Flush**         |
|------------|------------------|-------------------|
| **ä¸»è¦ç›®çš„**   | ä½¿æ–‡æ¡£**å¯è¢«æœç´¢**ï¼ˆè¿‘å®æ—¶ï¼‰ | ç¡®ä¿æ•°æ®**æŒä¹…åŒ–åˆ°ç£ç›˜**    |
| **å¯¹æœç´¢çš„å½±å“** | âœ… ä½¿æ–°æ–‡æ¡£ç«‹å³å¯æœç´¢      | âŒ ä¸å½±å“æ–‡æ¡£çš„å¯æœç´¢æ€§      |
| **æ•°æ®å®‰å…¨**   | âŒ ä¸ä¿è¯æ•°æ®å®‰å…¨        | âœ… ä¿è¯æ•°æ®å®‰å…¨ï¼ŒæŒä¹…åŒ–åˆ°ç£ç›˜   |
| **æ€§èƒ½å½±å“**   | å°ï¼ˆå†…å­˜æ“ä½œï¼‰          | å¤§ï¼ˆç£ç›˜ I/O æ“ä½œï¼‰      |
| **è§¦å‘é¢‘ç‡**   | é«˜ï¼ˆé»˜è®¤ 1 ç§’ï¼‰        | ä½ï¼ˆæ ¹æ® translog å¤§å°ï¼‰ |

---

## è¯¦ç»†è§£æ

### 1. **Refreshï¼ˆåˆ·æ–°ï¼‰ - ä¸ºäº†æœç´¢**

#### ä»€ä¹ˆæ˜¯ Refreshï¼Ÿ {id="refresh_1"}
```java
// Refresh çš„ç®€åŒ–è¿‡ç¨‹
public void refresh() {
    // 1. å°†å†…å­˜ç¼“å†²åŒº(In-memory Buffer)ä¸­çš„æ–‡æ¡£å†™å…¥æ–°çš„ Lucene æ®µ
    List<Document> buffer = indexBuffer.clear();
    LuceneSegment newSegment = createNewSegment(buffer);
    
    // 2. å°†æ–°æ®µå†™å…¥æ–‡ä»¶ç³»ç»Ÿç¼“å­˜(OS Cache)
    writeToOsCache(newSegment);
    
    // 3. æ‰“å¼€æ®µï¼Œä½¿å…¶å¯è¢«æœç´¢
    openSegmentForSearch(newSegment);
}
```

#### Refresh çš„ç‰¹ç‚¹ï¼š {id="refresh_2"}
- **è¿‘å®æ—¶æœç´¢**ï¼šæ–‡æ¡£åœ¨ç´¢å¼•åçº¦ 1 ç§’å˜å¾—å¯æœç´¢
- **å†…å­˜æ“ä½œ**ï¼šä¸»è¦å‘ç”Ÿåœ¨æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼Œä¸ç›´æ¥å†™ç£ç›˜
- **é«˜é¢‘æ“ä½œ**ï¼šé»˜è®¤æ¯ç§’ä¸€æ¬¡ï¼Œå¯é€šè¿‡ `index.refresh_interval` é…ç½®

#### Refresh é…ç½®ç¤ºä¾‹ï¼š
```json
// è®¾ç½®åˆ·æ–°é—´éš”ä¸º 30 ç§’
PUT /my_index/_settings
{
  "index.refresh_interval": "30s"
}

// å®Œå…¨å…³é—­è‡ªåŠ¨åˆ·æ–°ï¼ˆé€‚åˆæ‰¹é‡å¯¼å…¥ï¼‰
PUT /my_index/_settings
{
  "index.refresh_interval": "-1"
}

// æ‰‹åŠ¨è§¦å‘åˆ·æ–°
POST /my_index/_refresh
```

### 2. **Flushï¼ˆåˆ·ç›˜ï¼‰ - ä¸ºäº†æŒä¹…åŒ–**

#### ä»€ä¹ˆæ˜¯ Flushï¼Ÿ {id="flush_1"}
```java
// Flush çš„ç®€åŒ–è¿‡ç¨‹
public void flush() {
    // 1. å°†æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸­çš„æ‰€æœ‰æ®µæŒä¹…åŒ–åˆ°ç£ç›˜
    syncAllSegmentsToDisk();
    
    // 2. æ¸…ç©ºäº‹åŠ¡æ—¥å¿—(translog)ï¼Œåˆ›å»ºæ–°çš„ translog
    translog.clear();
    translog.createNew();
    
    // 3. åˆ›å»ºæäº¤ç‚¹(commit point)
    createCommitPoint();
}
```

#### Flush çš„ç‰¹ç‚¹ï¼š {id="flush_2"}
- **æ•°æ®å®‰å…¨**ï¼šç¡®ä¿æ•°æ®ç‰©ç†å†™å…¥ç£ç›˜
- **ç£ç›˜ I/O**ï¼šæ€§èƒ½å¼€é”€è¾ƒå¤§
- **ä½é¢‘æ“ä½œ**ï¼šåŸºäº translog å¤§å°è‡ªåŠ¨è§¦å‘

#### Flush è§¦å‘æ¡ä»¶ï¼š
```bash
# 1. translog å¤§å°è¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤ 512MBï¼‰
index.translog.flush_threshold_size: "512mb"

# 2. æ—¶é—´é—´éš”ï¼ˆé»˜è®¤ 30 åˆ†é’Ÿï¼‰
index.translog.flush_threshold_period: "30m"

# 3. æ“ä½œæ¬¡æ•°è¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤ä¸é™ï¼‰
index.translog.flush_threshold_ops: "unlimited"
```

---

## å¯è§†åŒ–æ•°æ®æµ

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªæµç¨‹å›¾æ¥ç†è§£è¿™ä¸¤ä¸ªæ“ä½œåœ¨æ•°æ®æµè½¬ä¸­çš„ä½ç½®ï¼š

```mermaid
flowchart TD
    A[æ–‡æ¡£ç´¢å¼•è¯·æ±‚] --> B[å†™å…¥å†…å­˜ç¼“å†²åŒº<br>Index Buffer]
    B --> C[å†™å…¥äº‹åŠ¡æ—¥å¿— Translog<br>ç¡®ä¿æŒä¹…æ€§]
    
    C --> D{Refresh è§¦å‘?}
    D -- æ˜¯ --> E[åˆ›å»ºæ–°Luceneæ®µ<br>å†™å…¥æ–‡ä»¶ç³»ç»Ÿç¼“å­˜]
    E --> F[ğŸ“š æ–‡æ¡£å¯è¢«æœç´¢]
    D -- å¦ --> B
    
    C --> G{Flush è§¦å‘?}
    G -- æ˜¯ --> H[å°†æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸­çš„æ®µ<br>æŒä¹…åŒ–åˆ°ç‰©ç†ç£ç›˜]
    H --> I[æ¸…ç©ºTranslog<br>åˆ›å»ºæ–°æäº¤ç‚¹]
    G -- å¦ --> C
    
    F --> J[ğŸ”’ æ•°æ®ä»åœ¨å†…å­˜ä¸­<br>æ–­ç”µå¯èƒ½ä¸¢å¤±]
    I --> K[ğŸ’¾ æ•°æ®å®‰å…¨æŒä¹…åŒ–]
```

---

## å®é™…åœºæ™¯ç¤ºä¾‹

### æ‰¹é‡æ•°æ®å¯¼å…¥ä¼˜åŒ–
```java
// 1. å…³é—­è‡ªåŠ¨åˆ·æ–°ä»¥æé«˜å¯¼å…¥é€Ÿåº¦
PUT /large_data/_settings
{
  "index.refresh_interval": "-1",
  "index.translog.durability": "async"  // å¼‚æ­¥ translog
}

// 2. æ‰§è¡Œæ‰¹é‡å¯¼å…¥
POST /large_data/_bulk
{ "index": {} }
{ "data": "value1" }
{ "index": {} }
{ "data": "value2" }

// 3. å¯¼å…¥å®Œæˆåæ‰‹åŠ¨åˆ·æ–°
POST /large_data/_refresh

// 4. ç¡®ä¿æ•°æ®æŒä¹…åŒ–
POST /large_data/_flush
```

### é«˜å®æ—¶æ€§æœç´¢åœºæ™¯
```java
// éœ€è¦å¿«é€Ÿæœç´¢ï¼Œä½†å¯ä»¥æ¥å—å°‘é‡æ•°æ®ä¸¢å¤±é£é™©
PUT /realtime_index/_settings
{
  "index.refresh_interval": "1s",           // å¿«é€Ÿåˆ·æ–°
  "index.translog.sync_interval": "5s",     // translog 5ç§’åˆ·ä¸€æ¬¡
  "index.translog.durability": "async"      // å¼‚æ­¥æŒä¹…åŒ–
}
```

---

## ç›‘æ§å’Œç®¡ç†

### æŸ¥çœ‹ Refresh å’Œ Flush ç»Ÿè®¡
```bash
# æŸ¥çœ‹ç´¢å¼•çš„ refresh ç»Ÿè®¡
GET /_stats/refresh?pretty

# æŸ¥çœ‹ç´¢å¼•çš„ flush ç»Ÿè®¡  
GET /_stats/flush?pretty

# è¾“å‡ºç¤ºä¾‹ï¼š
{
  "_shards": { ... },
  "_all": {
    "primaries": {
      "refresh": {
        "total": 100,           // æ€» refresh æ¬¡æ•°
        "total_time_in_millis": 5000  // æ€»è€—æ—¶
      },
      "flush": {
        "total": 5,             // æ€» flush æ¬¡æ•°
        "total_time_in_millis": 2000  // æ€»è€—æ—¶
      }
    }
  }
}
```

### æ‰‹åŠ¨æ“ä½œ API
```bash
# æ‰‹åŠ¨åˆ·æ–°ï¼ˆä½¿æ–‡æ¡£å¯æœç´¢ï¼‰
POST /my_index/_refresh

# æ‰‹åŠ¨åˆ·ç›˜ï¼ˆç¡®ä¿æ•°æ®æŒä¹…åŒ–ï¼‰
POST /my_index/_flush

# åˆ·ç›˜å¹¶ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ
POST /my_index/_flush?wait_if_ongoing=true
```

---

## æ€»ç»“

**ç®€å•è®°å¿†ï¼š**
- **Refresh** = **"è®©æˆ‘æœåˆ°"** â†’ è§£å†³æœç´¢å®æ—¶æ€§é—®é¢˜
- **Flush** = **"å¸®æˆ‘å­˜ç›˜"** â†’ è§£å†³æ•°æ®å®‰å…¨é—®é¢˜

**å…³é”®è¦ç‚¹ï¼š**
1. **Refresh å½±å“æœç´¢å¯è§æ€§**ï¼Œä½†ä¸ä¿è¯æ•°æ®å®‰å…¨
2. **Flush å½±å“æ•°æ®æŒä¹…æ€§**ï¼Œä½†ä¸å½±å“æœç´¢å¯è§æ€§
3. ä¸¤è€…ååŒå·¥ä½œï¼Œé€šè¿‡ **Translog** æœºåˆ¶ä¿è¯åœ¨ Refresh é¢‘ç¹æ‰§è¡Œæ—¶æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±
4. æ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼ˆå®æ—¶æœç´¢ vs æ‰¹é‡å¯¼å…¥ï¼‰åˆç†é…ç½®è¿™ä¸¤ä¸ªå‚æ•°å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
