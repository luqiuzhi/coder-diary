# 线程池和现代CPU

现代CPU几乎都是多核架构，并且有超线程技术，线程池的使用可以充分发挥现代CPU的多核优势。

但是线程池的设置也需要考虑CPU的核心数量才能真正发挥CPU的性能。

线程池中有一个核心的参数（无论是哪种线程池框架）就是核心线程数量，也就是常驻线程的数量。

该数量的设置和CPU的核心数量息息相关。但是我们首先要介绍一下CPU的核心数和线程数。

## CPU的核心与超线程

CPU的核心数，指的是硬件架构中的核心数量。例如我当前笔记本电脑使用的AMD CPU，型号为5800H，上面显示内核数为8，也就是有8个核心。

![cpu.png](cpu.png)

但是逻辑处理器有16个，是核心数的两倍。这是因为AMD也有自家的超线程技术——SMT（Simulate MultiThreading，同步多线程）。

而英特尔则是叫超线程技术——HT（Hyper-Threading Technology，超线程技术）。

![HT.png](HT.png)

不管是HT还是SMT都会将一个物理核心模拟成两个逻辑核心，而每个逻辑核心都可以并行处理计算任务。CPU的逻辑核心数量才是真实的可以并行计算的线程数。

所以线程池的数量的设置依据应该来自CPU的逻辑核心数量。

## 线程池的线程数量

线程池核心线程数量的设置可以遵循以下两个公式：

1. CPU密集型：线程池核心线程数量 = CPU逻辑核心数量 + 1
2. IO密集型：线程核心线程数量 = CPU逻辑核心数量 * 2 + 1

在讨论CPU密集性和IO密集型的区别的时候，我们首先要知道，系统在执行IO操作的时候是不需要消耗CPU资源的。

### CPU密集型 {id="cpu_1"}

CPU密集型的应用，在设置线程池的数量时，应该尽量保证在同一时间所有逻辑核心都处于工作状态，但是同时也不需要创建大量的无用线程，因为它们根本抢占不到CPU的资源。

那为什么在这里要设置比核心数多一个的线程数呢？主要是为了防止意外情况下，如线程本身执行错误，导致CPU资源处于空闲，那多出来的这一个线程可以有效的利用空闲的CPU。

### IO密集型

IO密集型由于IO操作较多，而IO操作本身也不消耗CPU资源的，所以IO密集型的应用可以设置较多的线程数，如逻辑核心的两倍，这样可以让其他线程在执行IO操作时，不至于让CPU闲下来。

但是线程数也不是越多越好，因为CPU在进行线程上下文的切换时也有开销。线程数过多时，切换线程的开销甚至大于实际执行线程任务的开销。

其实在IO密集型的应用中，有时候使用较多的线程也无法提升程序的性能。比如有以下场景：需要传输数量多且体积大的文件，使用线程池进行文件传输，系统性能瓶颈主要在网络IO方面。

而网络的带宽是一定的，即使CPU还未跑满的时候，网络带宽已经全部被占用，此时所有的线程都只好挂起等待。

所以以上两个公式的根本原则不难看出，就是为了跑满CPU。但是CPU的有效利用和应用的性能提升有时候没有必然的联系，特别是在执行IO密集型任务时。

（关于线程池和现代CPU的故事还有的讲，下回继续~）

